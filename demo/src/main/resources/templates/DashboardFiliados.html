<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Uni√£o Brasil</title>
    <meta
      content="width=device-width, initial-scale=1.0, shrink-to-fit=no"
      name="viewport"
    />
    <link rel="icon" th:href="@{/img/ub.jfif}" />
    <!-- Incluindo o Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
  <!-- Carregando jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- Carregando jQuery Notify -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-notify/1.0.2/jquery.notify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    
    <!-- Fonts and icons -->
      <script th:src="@{/js/plugin/webfont/webfont.min.js}"></script>

    <script>
      WebFont.load({
        google: { families: ["Public Sans:300,400,500,600,700"] },
        custom: {
          families: [
            "Font Awesome 5 Solid",
            "Font Awesome 5 Regular",
            "Font Awesome 5 Brands",
            "simple-line-icons",
          ],
          urls: ["/css/fonts.min.css"], // Corrigido aqui
        },
        active: function () {
          sessionStorage.fonts = true;
        },
      });
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@700&display=swap" rel="stylesheet">

    <!-- CSS Files -->
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}" />
    <link rel="stylesheet" th:href="@{/css/plugins.min.css}" />
    <link rel="stylesheet" th:href="@{/css/kaiadmin.min.css}" />
    <!-- CSS Just for demo purpose, don't include it in your project -->
    <link rel="stylesheet" th:href="@{/css/demo.css}" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  </head>
  <body>
    <div class="wrapper">
      <!-- Sidebar -->
      <div class="sidebar" data-background-color="white">
        <div class="sidebar-logo">
          <!-- Logo Header -->
          <div class="logo-header" data-background-color="white">
            <a th:href="@{/index}" class="logo">
              <img
                th:src="@{/img/logo.ico}"
                alt="navbar brand"
                class="navbar-brand"
               
              />
            </a>
            <div class="nav-toggle">
              <button class="btn btn-toggle toggle-sidebar">
                <i class="gg-menu-right"></i>
              </button>
              <button class="btn btn-toggle sidenav-toggler">
                <i class="gg-menu-left"></i>
              </button>
            </div>
            <button class="topbar-toggler more">
              <i class="gg-more-vertical-alt"></i>
            </button>
          </div>
          <!-- Fim do Cabe√ßalho do Logo -->
        </div>
  
        <div class="sidebar-wrapper scrollbar scrollbar-inner">
          <div class="sidebar-content">
            <ul class="nav nav-secondary">
              <li class="nav-item active">
                <a th:href="@{/index}"class="fas fa-home"><i class="fas fa-home"></i>inicio</a>
      
              </li>
              <li class="nav-section">
                <span class="sidebar-mini-icon">
                  <i class="fa fa-ellipsis-h"></i>
                </span>
                <h4 class="text-section">Menu</h4>
              </li>
              <li class="nav-item">
                <a data-bs-toggle="collapse" href="#tables">
                  <i class="bi bi-person-plus"></i>
                  <p>Cadastros</p>
                  <span class="caret"></span>
                </a>
                <div class="collapse" id="tables">
                  <ul class="nav nav-collapse">
                    <li>
                      <a th:href="@{/novo-filiado}">
                        <span class="sub-item"> Cadastrar Filiado Interno</span>
                      </a>
                    </li>
                    <li>
                      <a th:href="@{/cadastrar}">
                        <span class="sub-item">Novo Usu√°rio</span>
                      </a>
                    </li>
                  
                  </ul>
                </div>
              </li>
              <li class="nav-item">
                <a data-bs-toggle="collapse" href="#tables">
                  <i class="fas fa-table"></i>
                  <p>Consultas</p>
                  <span class="caret"></span>
                </a>
                <div class="collapse" id="tables">
                  <ul class="nav nav-collapse">

                   
                   
                    <li>
                      <a th:href="@{/filiados}">
                        <span class="sub-item">Filiados</span>
                      </a>
                    </li>
                    
                    <li>
                      <a th:href="@{/candidatos}">
                        <span class="sub-item">Cargos</span>
                      </a>
                    </li>
                  
                  </ul>
                </div>
              </li>
              <li class="nav-item">
                <a href="#" class="nav-link d-flex align-items-center" aria-label="Ir para documentos">
                  <i class="fas fa-file mr-2"></i>
                  <span class="sub-item mr-2">Documentos</span>
                  <span class="badge badge-secondary" aria-hidden="true">1</span>
                </a>
              </li>
              
             
            </ul>
          </div>
        </div>
      </div>
      <!-- final menu vertical -->

      <div class="main-panel">
        <div class="main-header">
          <div class="main-header-logo">
            <!-- Logo Header -->
            <div class="logo-header" data-background-color="dark">
              <a th:href="@{../index.html}" class="logo">
                <img
                  th:src="@{/img/logo.ico}"
                  alt="navbar brand"
                  class="navbar-brand"
                
                />
              </a>
              <div class="nav-toggle">
                <button class="btn btn-toggle toggle-sidebar">
                  <i class="gg-menu-right"></i>
                </button>
                <button class="btn btn-toggle sidenav-toggler">
                  <i class="gg-menu-left"></i>
                </button>
              </div>
              <button class="topbar-toggler more">
                <i class="gg-more-vertical-alt"></i>
              </button>
            </div>
            <!-- End Logo Header -->
          </div>
          <!-- Navbar Header -->
          <nav
            class="navbar navbar-header navbar-header-transparent navbar-expand-lg border-bottom"
          >
            <div class="container-fluid">
              <nav
                class="navbar navbar-header-left navbar-expand-lg navbar-form nav-search p-0 d-none d-lg-flex"
              >
                <div class="input-group-prepend">
                  </div>
                  


                    <span class="profile-username">
                      <button class="btn btn-info" onclick="window.location.href='/filiados';">Voltar</button>
                      <span class="op-7"  style="font-family: 'Roboto', sans-serif; font-size: 18px; font-weight: bold;"></span>
                      <span  style="font-family: 'Roboto', sans-serif; font-size: 18px; font-weight: bold;">Sua Fun√ß√£o Definida √©:
                     <span th:text="${userFuncao}"  style="font-family: 'Roboto', sans-serif; font-size: 18px; font-weight: bold; color:blue;"></span>!</span>
                     
                  </span>
             
              </nav>

              <ul class="navbar-nav topbar-nav ms-md-auto align-items-center">
                <li
                  class="nav-item topbar-icon dropdown hidden-caret d-flex d-lg-none"
                >
                  <a
                    class="nav-link dropdown-toggle"
                    data-bs-toggle="dropdown"
                    href="#"
                    role="button"
                    aria-expanded="false"
                    aria-haspopup="true"
                  >
                    <i class="fa fa-search"></i>
                  </a>
                  
                </li>
                <li class="nav-item topbar-user dropdown hidden-caret">
                  <a
                    class="dropdown-toggle profile-pic"
                    data-bs-toggle="dropdown"
                    href="#"
                    aria-expanded="false"
                  >
                
                  </a>
                 
                </li>
              </ul>
            </div>
          </nav>
          <!-- End Navbar -->
        </div>
        <div class="container">
          <div class="page-inner">
            <form action="/dashboardFiliados" method="get" id="filterForm">
              <div class="col-md-12 mb-4">
                  <div class="card card-stats card-round">
                      <div class="card-body">
                          <div class="row align-items-center">
                              <div class="col-icon">
                                  <div class="icon-big text-center icon-primary bubble-shadow-small">
                                      <i class="fas fa-filter"></i>
                                  </div>
                              </div>
                              <div class="col col-stats ms-3 ms-sm-0">
                                      <div class="numbers">
                                      <p class="card-category">FILTRAR</p>
                                      <div class="d-flex align-items-center mb-3">
                                        <div class="col-md-2 mb-3">
                                          <label for="anoSelect" class="form-label">ANO: </label>
                                          <input type="number" id="anoSelect" class="form-control">
                                              
                                          </input>
                                      </div>
                                            <div class="col-md-3 mb-3">
                                              <label for="ufSelect" class="form-label"> UF: </label>
                                              <select id="ufSelect" class="form-control">
                                                  
                                              </select>
                                            </div>
                                            <div class="col-md-3 mb-3">
                                              <label for="municipioSelect" class="form-label"> MUNICIPIO: </label>
                                              <select id="municipioSelect" class="form-control">
                                                  
                                              </select>
                                            </div>
                                            <div class="col-md-4 mb-3">
                                              <label for="generoSelect" class="form-label">G√™nero: </label>
                                              <select id="generoSelect" class="form-control">
                                                  <option value="">Selecione o G√™nero</option>
                                                  <option value="FEMININO">FEMININO</option>
                                                  <option value="MASCULINO">MASCULINO</option>
                                              </select>
                                          </div>
                                            <div class=" d-flex align-items-end">
                                                <button id="btnPesquisar" class="btn btn-primary">Pesquisar</button>
                                            </div>
                                          </div>
                                      </div>
                                  </div>
                              </div>
                          </div>
                      </div>
                    </div>
                  </form>
                <br>
                <div style="text-align: center; display: flex; justify-content: space-between;">

                  <!-- Gr√°fico de Filiado por UF -->
                  <div id="Grafico_filiado" style="height:150px; width: 80%;">Gr√°fico de Filiado por UF</div>
                  <!-- Gr√°fico de Filiado por G√™nero -->
                  <div id="Grafico_genero" style="height:150px; width: 25%;">Gr√°fico Filiado por G√™nero</div>
              </div>
           
                <div id="Grafico_municipio"style="height:150px; width: 70%;">Gr√°fico de Filiado por Munic√≠pios 10 maiores</div>
                <div>
                    <button id="prevPage" style="display:none;">‚¨Ö Anterior</button>
                    <button id="nextPage" style="display:none;">Pr√≥ximo ‚û°</button>
                </div>
              </div>
            </div>

        <script>   
 async function preencherUFSelect() {
            // Lista das UFs (substitua com a lista real de UFs se necess√°rio)
      const ufs = [
          'AC', 'AL', 'AP', 'AM', 'BA', 'CE', 'DF', 'ES', 'GO', 'MA', 'MT', 'MS', 'MG', 
          'PA', 'PB', 'PR', 'PE', 'PI', 'RJ', 'RN', 'RS', 'RO', 'RR', 'SC', 'SP', 'SE', 'TO'
      ];
    
      // Ordena as UFs em ordem alfab√©tica
      ufs.sort();
        // Faz a requisi√ß√£o para obter o usu√°rio logado
        const response = await fetch("/api/usuario/logado");
        const dataUsuario = await response.json();
        const ufUsuario = dataUsuario.uf;  // UF do usu√°rio logado
        const roleUsuario = dataUsuario.funcao;  // Fun√ß√£o do usu√°rio (role)
    
        // Ordena as UFs
        ufs.sort();
    
        // Limpa o conte√∫do do select antes de preench√™-lo
        ufSelect.innerHTML = '';
        // Se o usu√°rio for operador estadual, a UF ser√° a do usu√°rio logado
        if (["CONSULTOR_ESTADUAL", "OPERADOR_ESTADUAL", "ADM_ESTADUAL","OPERADOR_MUNICIPAL","CONSULTOR_MUNICIPAL"].includes(roleUsuario) && ufUsuario) {
            const option = document.createElement('option');
            option.value = ufUsuario;
            option.textContent = ufUsuario;
            option.selected = true;  // Define a UF do usu√°rio como selecionada
            ufSelect.appendChild(option);
            $('#btnPesquisar').click();
        }else{
            // Adiciona a op√ß√£o "Todos"
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Todos';
            ufSelect.appendChild(defaultOption);
             // Adiciona as outras UFs ao select, exceto a UF j√° selecionada
            ufs.forEach(uf => {
              if (uf !== ufUsuario) {
                  const option = document.createElement('option');
                  option.value = uf;
                  option.textContent = uf;
                  ufSelect.appendChild(option);
              }
          });
        }
       
    }
    // Evento para carregar os munic√≠pios com base na UF selecionada
    document.getElementById('ufSelect').addEventListener('change', function() {
      const ufSelecionada = this.value;
      const municipio = document.querySelector("#municipioSelect").value;

      // Limpa as op√ß√µes anteriores
      municipioSelect.innerHTML = '<option value="">Selecione o munic√≠pio</option>';

      if (ufSelecionada) {
          municipioSelect.disabled = false; // Habilita o campo de munic√≠pio

          fetch(`/api/municipios/${ufSelecionada}`)
              .then(response => {
                  if (!response.ok) {
                      throw new Error('Erro na resposta da rede');
                  }
                  return response.json();
              })
              .then(municipios => {
                  municipios.forEach(function(municipio) {
                      const option = document.createElement('option');
                      option.value = municipio.municipio; // ou o ID do munic√≠pio
                      option.textContent = municipio.municipio;
                      municipioSelect.appendChild(option);
                  });
              })
              .catch(error => {
                  console.error('Erro ao buscar munic√≠pios:', error);
                  municipioSelect.disabled = false; // Permite que o campo permane√ßa habilitado
              });
      } else {
          municipioSelect.disabled = true; // Desabilita se n√£o houver UF selecionada
      }
    });

    // Habilita o campo de munic√≠pio ao carregar a p√°gina se a UF j√° estiver selecionada
    document.addEventListener("DOMContentLoaded", function() {
      if (ufSelecionada) {
          document.getElementById('ufSelect').dispatchEvent(new Event('change'));
      }
    });
    // Chama a fun√ß√£o para preencher o select ao carregar a p√°gina
    preencherUFSelect();
    $(document).ready(function() {
      const municipioSelect = document.getElementById('municipioSelect');
      municipioSelect.disabled = true;
      setTimeout(() => {
        $('#btnPesquisar').trigger('click');
    }, 500);
      $('#btnPesquisar').on('click', function(event) {
        // Previne o comportamento padr√£o (n√£o recarregar a p√°gina)
        event.preventDefault();
    
        // Captura os valores dos campos
        const ano = $('#anoSelect').val();
        const uf = $('#ufSelect').val();
        const genero = $('#generoSelect').val();
        const municipio = $('#municipioSelect').val();
        
        console.log("Ano selecionado:", ano);
        console.log("UF selecionada:", uf);
        console.log("G√™nero selecionado:", genero);
        console.log("Municipio selecionado:", municipio);
        
        // Chama a fun√ß√£o para buscar os dados com os filtros
        fetchData(ano, uf, genero,municipio);
      });
    });
    async function fetchData(ano, uf,genero,municipio) {
      try {
        let url = '/api/filiado?'; // URL base

        if (ano !== '') { 
          url += `anoFiliacao=${ano}`;  // Filtro de ano
        }
      
        if (uf !== '') { 
          url +=  `&uf=${uf}`;  
        }
    
        if (genero !== '') { 
          url +=  `&genero=${genero}`; 
        }
        if (municipio && municipio.trim() !== '') { 
          url +=  `&municipio=${municipio}`;  
        }
     // console.log("URL final com filtros:", url); // Verificar a URL antes da requisi√ß√£o
      const response = await fetch(url);
      const data = await response.json(); // Espera a resposta com os dados de candidatos
      console.log(data);
      // Organize the data for the chart
      renderChart( data,ano,uf,genero,municipio);
      updateGeneroChart(data,ano,uf,genero,municipio); 
      updateMunicipioChart(data, ano, uf, genero,municipio);
  } catch (error) {
      console.error('Erro ao buscar dados:', error);
  }
}
let renderChartInstance = null; // Declare apenas dentro da fun√ß√£o
function renderChart(data, ano, uf, genero,municipio) {
  const chartElement = document.querySelector("#Grafico_filiado");
  if (!chartElement) {
    console.error("Elemento de gr√°fico n√£o encontrado.");
    return;
}

  let filteredData = data;
 // Aplica os filtros
 if (uf !== '') {
  filteredData = filteredData.filter(item => item.uf === uf);
}
ano = ano ? parseInt(ano, 10) : '';
if (ano !== '') {
  filteredData = filteredData.filter(item => parseInt(item.anoFiliacao, 10) === ano);
}

if (genero !== '') {
  filteredData = filteredData.filter(item => item.genero === genero);
}
if (municipio && municipio.trim() !== '') {
  filteredData = filteredData.filter(item => item.municipio === municipio);
}


// Verifica se filteredData tem dados ap√≥s os filtros
if (filteredData.length === 0) {
  console.log("Nenhum dado encontrado com os filtros aplicados.");
  return;
}
  const ufCount = {};
// Contabilizando os filiados por UF com os dados filtrados
filteredData.forEach(item => {
    if (ufCount[item.uf]) {
        ufCount[item.uf]++;
    } else {
        ufCount[item.uf] = 1;
    }
});
  // Gerar as categorias (ufs) e os dados de contagem
  const categories = Object.keys(ufCount);
  let seriesData = categories.map(uf => ufCount[uf]);

  // Ordenar os dados do maior para o menor
  const sortedData = categories.map((uf, index) => ({
      uf: uf,
      count: seriesData[index]
  })).sort((a, b) => b.count - a.count);

  // Reorganizar as categorias e os dados ap√≥s ordena√ß√£o
  const sortedCategories = sortedData.map(item => item.uf);
  const sortedSeriesData = sortedData.map(item => item.count);

  // Formatar os valores com "k" ou "M" para exibi√ß√£o nos dataLabels
  const formattedSeriesData = sortedSeriesData.map(count => formatNumber(count));

  // Gerar cores azul para o gr√°fico
  const colors = sortedSeriesData.map(() => '#F4A623'); // Azul

  const options = {
      series: [{
          name: 'Filiados',
          data: sortedSeriesData // Usando os valores brutos para o gr√°fico
      }],
      chart: {
          height: 350,
          type: 'bar',
          events: {
              dataPointMouseEnter: function(event, chartContext, config) {
                  const uf = sortedCategories[config.dataPointIndex];
                  updateGeneroChart(data, ano,uf,genero,municipio);
                  updateMunicipioChart(data, ano, uf, genero,municipio);
                  console.log("UF:", uf);
              }
          }
      },
      colors: colors,
      plotOptions: {
          bar: {
              columnWidth: '45%',
              distributed: true,
              dataLabels: {
                position: 'top'
            
              },
          }
      },
      dataLabels: {
          enabled: true, // Exibe os n√∫meros fora das barras
          formatter: function(val) {
              return formatNumber(val); // Formata os n√∫meros com "k" ou "M"
          },
          style: {
              colors: ['#000000'], // Cor preta para os n√∫meros
              fontSize: '14px',
              fontWeight: 'bold'
          },
         
           offsetX: 0, // Posi√ß√£o horizontal do n√∫mero (0 para manter alinhado)
            offsetY: -20, // Posi√ß√£o vertical do n√∫mero, ajustando para ficar em cima da barra
            verticalAlign: 'top' // Alinha os n√∫meros na parte inferior do ponto (em cima da barra)
      },
      legend: {
          show: false
      },
      xaxis: {
          categories: sortedCategories, // Exibe as UFs ordenadas
          labels: {
              style: {
                  fontSize: '12px',
              }
          }
      },
      yaxis: {
          show: true,
          labels: {
              formatter: function(value) {
                  return formatNumber(value); // Formata os valores no eixo Y
              }
          }
      },
      labels: {
          style: {
              colors: colors,
              fontSize: '12px'
          }
      }
  };
 // Se o gr√°fico de g√™nero j√° foi criado, destrua-o antes de criar um novo
 if (renderChartInstance !== null) {
  renderChartInstance.destroy(); // Destruir a inst√¢ncia anterior
}

// Cria o gr√°fico de g√™nero
renderChartInstance = new ApexCharts(chartElement, options);

try {
  renderChartInstance.render();
  console.log(`Gr√°fico de filiados para a UF ${uf} renderizado com sucesso!`);
} catch (error) {
  console.error("Erro ao renderizar o gr√°fico:", error);
}
}

// Fun√ß√£o para formatar n√∫meros com "k" e "M"
function formatNumber(value) {
  if (value >= 1000000) {
      return (value / 1000000).toFixed(1) + "M"; // Ex: 1.5M
  } else if (value >= 1000) {
      return (value / 1000).toFixed(1) + "k"; // Ex: 2.5k
  }
  return value.toString();
}
/**********************************************************************************************************************************************/
let generoChart = null; // Vari√°vel global para armazenar o gr√°fico de g√™nero
  function updateGeneroChart(data, ano,uf,genero,municipio) {
 // Inicializa filteredData com todos os dados
    let filteredData = data;

    // Aplica os filtros de forma condicional
    if (uf !== '') {
      filteredData = filteredData.filter(item => item.uf === uf);
    }

    ano = ano ? parseInt(ano, 10) : '';
    if (ano !== '') {
      filteredData = filteredData.filter(item => parseInt(item.anoFiliacao, 10) === ano);
    }
    if (municipio && municipio.trim() !== '') {
      filteredData = filteredData.filter(item => item.municipio === municipio);
    }
    


    // Verifica se h√° dados ap√≥s a filtragem
    if (filteredData.length === 0) {
      console.log("Nenhum dado encontrado com os filtros aplicados.");
      return;
    }

    // Inicializa as vari√°veis de contagem
    let maleCount = 0;
    let femaleCount = 0;

    // Filtra os dados por g√™nero
    if (genero === 'FEMININO') {
      femaleCount = filteredData.filter(item => item.genero === 'FEMININO').length;
    } else if (genero === 'MASCULINO') {
      maleCount = filteredData.filter(item => item.genero === 'MASCULINO').length;
    } else {
      // Se nenhum g√™nero espec√≠fico for filtrado, conta os dois g√™neros
      maleCount = filteredData.filter(item => item.genero === 'MASCULINO').length;
      femaleCount = filteredData.filter(item => item.genero === 'FEMININO').length;
    }
    let seriesData = [];
    let labels = [];
    let colors = [];

    if (genero === 'MASCULINO') {
        seriesData = [maleCount];
        labels = ['Masculino'];
        colors = ['rgb(14, 98, 243)']; // Azul
    } else if (genero === 'FEMININO') {
        seriesData = [femaleCount];
        labels = ['Feminino'];
        colors = ['#FF69B4']; // Rosa
    } else {
        seriesData = [maleCount, femaleCount];
        labels = ['Masculino', 'Feminino'];
        colors = ['rgb(14, 98, 243)', '#FF69B4']; // Azul e rosa
    }
  
      console.log("Dados antes dos filtros:", data);
      console.log("UF selecionado:", uf);
      console.log("G√™nero selecionado:", genero);
      console.log("Dados ap√≥s filtros:", filteredData);
      
  
       // Definindo o t√≠tulo para a UF
    const title = `G√™nero dos candidatos da UF: ${uf}`;

    const options = {
      series: seriesData,
        chart: {
            type: 'pie',
        },
        labels: labels,
        colors: colors,
        title: {
            text: title, // Exibe a UF no t√≠tulo do gr√°fico
            align: 'center',
            style: {
                fontSize: '12px',
                fontWeight: 'bold',
                color: '#333'
            }
        },
        responsive: [{
            breakpoint: 480,
            options: {
                chart: {
                    width: 200
                },
                legend: {
                    position: 'bottom'
                }
            }
        }]
    };
      const chartElement = document.querySelector("#Grafico_genero");
  
      if (!chartElement) {
          //console.error("Elemento de gr√°fico de g√™nero n√£o encontrado.");
          return;
      }
  
      // Se o gr√°fico de g√™nero j√° foi criado, destrua-o antes de criar um novo
      if (generoChart !== null) {
          generoChart.destroy();
      }
  
      // Cria o gr√°fico de g√™nero
      generoChart = new ApexCharts(chartElement, options);
  
      try {
          generoChart.render();
          //console.log(`Gr√°fico de g√™nero para a UF ${uf} renderizado com sucesso!`);
      } catch (error) {
         // console.error("Erro ao renderizar o gr√°fico de g√™nero:", error);
      }
  }
  /**************************************************************************************************************************************************/
  let currentPage = 0; // P√°gina inicial
  const itemsPerPage = 10; // Quantidade de munic√≠pios por p√°gina
  let allMunicipiosSorted = []; // Armazena todos os munic√≠pios do UF
  let selectedUF = ""; // üî• Guarda o UF selecionado
  
  function updateMunicipioChart(data, ano, uf, genero, municipio) {
    const chartElement = document.querySelector("#Grafico_municipio");
    let filteredData = data;

    // Aplicando filtros condicionais
    if (uf !== '') {
        filteredData = filteredData.filter(item => item.uf === uf);
    }

    ano = ano ? parseInt(ano, 10) : '';
    if (ano !== '') {
        filteredData = filteredData.filter(item => parseInt(item.anoFiliacao, 10) === ano);
    }

    selectedUF = uf; // Armazena o UF selecionado

    // Contagem de munic√≠pios
    const ufMunicipioCount = {};

    filteredData.forEach(item => {
        const estado = item.uf;
        const cidade = item.municipio;

        if (!ufMunicipioCount[estado]) {
            ufMunicipioCount[estado] = {};
        }

        ufMunicipioCount[estado][cidade] = (ufMunicipioCount[estado][cidade] || 0) + 1;
    });

    // L√≥gica para exibir todos os munic√≠pios ou apenas o filtrado
    if (municipio && municipio.trim() !== '') {
        // Exibir apenas o munic√≠pio selecionado
        allMunicipiosSorted = [{
            municipio: municipio,
            count: ufMunicipioCount[uf]?.[municipio] || 0
        }];
    } else {
        // Exibir todos os munic√≠pios do estado ordenados
        allMunicipiosSorted = Object.keys(ufMunicipioCount[uf] || {})
            .map(cidade => ({
                municipio: cidade,
                count: ufMunicipioCount[uf][cidade]
            }))
            .sort((a, b) => b.count - a.count);
    }

    currentPage = 0; // Reinicia a p√°gina
    renderMunicipioChart(chartElement, uf, ano, municipio, genero);
}
  function renderMunicipioChart(chartElement, uf,ano,municipio,genero) {
      // Calcula o √≠ndice inicial e final da p√°gina
      const startIndex = currentPage * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;

    let pageData;
    if (municipio && municipio.trim() !== '') {
        // Mostrar apenas o munic√≠pio filtrado
        pageData = allMunicipiosSorted;
    } else {
        // Mostrar todos os munic√≠pios do estado paginados
        pageData = allMunicipiosSorted.slice(startIndex, endIndex);
    }

    const sortedCategories = pageData.map(item => item.municipio);
    const sortedSeriesData = pageData.map(item => item.count);
    const colors = sortedSeriesData.map(() => '#00A4E8'); // Azul
      const options = {
          series: [{ data: sortedSeriesData }],
          chart: {
              type: 'bar',
              height: 400,
              toolbar: { show: false },
              animations: { enabled: true }
          },
          plotOptions: {
              bar: {
                  borderRadius: 4,
                  horizontal: true,
                  dataLabels: {
                    position: 'top'
                
                  },
              },
          },
          dataLabels: {
              enabled: true,
              formatter: function(val) {
                  return formatNumber(val);
              },
              style: {
                  colors: ['#000000'],
                  fontSize: '14px',
                  fontWeight: 'bold'
              },
              offsetX: 20, // üî• Move o n√∫mero para fora da barra
              textAnchor: 'start' // üî• Garante que o texto seja ancorado corretamente
          },
          xaxis: { categories: sortedCategories },
          colors: colors,
          yaxis: {
              labels: {
                  formatter: function(value) {
                      return formatNumber(value);
                  },
                  style: {
                    fontSize: '15px',  // Aumentando o tamanho da fonte
                    color: '#333333',  // Cor da letra mais escura
                }
              }
          },
          title: {
            text: `Top Munic√≠pios em ${selectedUF} - P√°gina ${currentPage + 1}`, // üî• Agora mant√©m o UF correto
              align: 'center'
          }
      };
  
      // Remove o gr√°fico antigo, se houver
      if (window.municipioChart) {
          window.municipioChart.destroy();
      }
  
      // Cria o gr√°fico com as novas op√ß√µes
      window.municipioChart = new ApexCharts(chartElement, options);
      window.municipioChart.render();
  
      // Atualiza a exibi√ß√£o dos bot√µes de pagina√ß√£o
      updatePaginationButtons();
  }
  
  // Atualiza a exibi√ß√£o dos bot√µes de pagina√ß√£o
  function updatePaginationButtons() {
      document.getElementById("prevPage").style.display = currentPage > 0 ? "inline-block" : "none";
      document.getElementById("nextPage").style.display = (currentPage + 1) * itemsPerPage < allMunicipiosSorted.length ? "inline-block" : "none";
  }
  
  // Bot√£o de pr√≥xima p√°gina
  document.getElementById("nextPage").addEventListener("click", function () {
      if ((currentPage + 1) * itemsPerPage < allMunicipiosSorted.length) {
          currentPage++;
          renderMunicipioChart(document.querySelector("#Grafico_municipio"), allMunicipiosSorted[0].uf);
      }
  });
  
  // Bot√£o de p√°gina anterior
  document.getElementById("prevPage").addEventListener("click", function () {
      if (currentPage > 0) {
          currentPage--;
          renderMunicipioChart(document.querySelector("#Grafico_municipio"), allMunicipiosSorted[0].uf);
      }
  });
  
  // Fun√ß√£o auxiliar para formatar n√∫meros
  function formatNumber(value) {
      if (value >= 1e6) return (value / 1e6).toFixed(1) + "M";
      if (value >= 1e3) return (value / 1e3).toFixed(1) + "k";
      return value.toString();
  }
  

 </script>
<footer class="footer">
<div class="container-fluid d-flex justify-content-between">
  <nav class="pull-left">
    <ul class="nav">
      <li class="nav-item">
        <a class="nav-link" th:href="@{https://uniaobrasil.org.br/filie-se/}">
          Filiar 
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="https://wa.me/61994180629?text=Ol√°%2C%20gostaria%20de%20mais%20informa√ß√µes">  Ajuda </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#"> Uni√£o Brasil </a>
      </li>
    </ul>
  </nav>
  <div class="copyright">
    2024, Uni√£o Brasil <i class="fa fa-heart heart text-danger"></i> by
    <a th:href="@{https://uniaobrasil.org.br/}">Site</a>
  </div>

</div>
</footer>
</div>



<!-- Custom template | don't include it in your project! -->
<div class="custom-template">
<div class="title">Configurar</div>
<div class="custom-content">
<div class="switcher">
  <div class="switch-block">
    <h4>Logo Header</h4>
    <div class="btnSwitch">
      <button
        type="button"
        class="selected changeLogoHeaderColor"
        data-color="dark"
      ></button>
      <button
        type="button"
        class="changeLogoHeaderColor"
        data-color="blue"
      ></button>
      <button
        type="button"
        class="changeLogoHeaderColor"
        data-color="purple"
      ></button>
      <button
        type="button"
        class="changeLogoHeaderColor"
        data-color="light-blue"
      ></button>
      <button
        type="button"
        class="changeLogoHeaderColor"
        data-color="green"
      ></button>
      <button
        type="button"
        class="changeLogoHeaderColor"
        data-color="orange"
      ></button>
      <button
        type="button"
        class="changeLogoHeaderColor"
        data-color="red"
      ></button>
      <button
        type="button"
        class="changeLogoHeaderColor"
        data-color="white"
      ></button>
      <br />
      <button
        type="button"
        class="changeLogoHeaderColor"
        data-color="dark2"
      ></button>
      <button
        type="button"
        class="changeLogoHeaderColor"
        data-color="blue2"
      ></button>
      <button
        type="button"
        class="changeLogoHeaderColor"
        data-color="purple2"
      ></button>
      <button
        type="button"
        class="changeLogoHeaderColor"
        data-color="light-blue2"
      ></button>
      <button
        type="button"
        class="changeLogoHeaderColor"
        data-color="green2"
      ></button>
      <button
        type="button"
        class="changeLogoHeaderColor"
        data-color="orange2"
      ></button>
      <button
        type="button"
        class="changeLogoHeaderColor"
        data-color="red2"
      ></button>
    </div>
  </div>
  <div class="switch-block">
    <h4>Menu vertical</h4>
    <div class="btnSwitch">
      <button
        type="button"
        class="changeTopBarColor"
        data-color="dark"
      ></button>
      <button
        type="button"
        class="changeTopBarColor"
        data-color="blue"
      ></button>
      <button
        type="button"
        class="changeTopBarColor"
        data-color="purple"
      ></button>
      <button
        type="button"
        class="changeTopBarColor"
        data-color="light-blue"
      ></button>
      <button
        type="button"
        class="changeTopBarColor"
        data-color="green"
      ></button>
      <button
        type="button"
        class="changeTopBarColor"
        data-color="orange"
      ></button>
      <button
        type="button"
        class="changeTopBarColor"
        data-color="red"
      ></button>
      <button
        type="button"
        class="selected changeTopBarColor"
        data-color="white"
      ></button>
      <br />
      <button
        type="button"
        class="changeTopBarColor"
        data-color="dark2"
      ></button>
      <button
        type="button"
        class="changeTopBarColor"
        data-color="blue2"
      ></button>
      <button
        type="button"
        class="changeTopBarColor"
        data-color="purple2"
      ></button>
      <button
        type="button"
        class="changeTopBarColor"
        data-color="light-blue2"
      ></button>
      <button
        type="button"
        class="changeTopBarColor"
        data-color="green2"
      ></button>
      <button
        type="button"
        class="changeTopBarColor"
        data-color="orange2"
      ></button>
      <button
        type="button"
        class="changeTopBarColor"
        data-color="red2"
      ></button>
    </div>
  </div>
  <div class="switch-block">
    <h4>Menu Horizontal</h4>
    <div class="btnSwitch">
      <button
        type="button"
        class="changeSideBarColor"
        data-color="white"
      ></button>
      <button
        type="button"
        class="selected changeSideBarColor"
        data-color="dark"
      ></button>
      <button
        type="button"
        class="changeSideBarColor"
        data-color="dark2"
      ></button>
    </div>
  </div>
</div>
</div>
<div class="custom-toggle">
<i class="icon-settings"></i>
</div>
</div>
<!-- End Custom template -->

<!-- Core JS Files -->
<script th:src="@{/js/core/jquery-3.7.1.min.js}"></script>
<script th:src="@{/js/core/popper.min.js}"></script>
<script th:src="@{/js/core/bootstrap.min.js}"></script>

<!-- jQuery Scrollbar -->
<script th:src="@{/js/plugin/jquery-scrollbar/jquery.scrollbar.min.js}"></script>

<!-- Chart JS -->
<script th:src="@{/js/plugin/chart.js/chart.min.js}"></script>

<!-- jQuery Sparkline -->
<script th:src="@{/js/plugin/jquery.sparkline/jquery.sparkline.min.js}"></script>

<!-- Chart Circle -->
<script th:src="@{/js/plugin/chart-circle/circles.min.js}"></script>

<!-- Datatables -->
<script th:src="@{/js/plugin/datatables/datatables.min.js}"></script>

<!-- Bootstrap Notify -->
<!--<script th:src="@{/js/plugin/bootstrap-notify/bootstrap-notify.min.js}"></script>-->

<!-- jQuery Vector Maps -->
<script th:src="@{/js/plugin/jsvectormap/jsvectormap.min.js}"></script>
<script th:src="@{/js/plugin/jsvectormap/world.js}"></script>

<!-- Sweet Alert -->
<script th:src="@{/js/plugin/sweetalert/sweetalert.min.js}"></script>

<!-- Kaiadmin JS -->
<script th:src="@{/js/kaiadmin.min.js}"></script>

<!-- Kaiadmin DEMO methods, don't include it in your project! -->
<script th:src="@{/js/setting-demo.js}"></script>
<script th:src="@{/js/demo.js}"></script>
</body>
</html>
